name: ğŸš€ Build and Release

on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - 'master'
      - 'main'
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘å‘å¸ƒ
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v2.0.1)'
        required: true
        default: 'v2.0.0'
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

# è®¾ç½®æƒé™
permissions:
  contents: write
  packages: write

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'

jobs:
  # ç»Ÿä¸€çš„æ„å»ºã€æµ‹è¯•å’Œå‘å¸ƒæµç¨‹
  build-test-release:
    name: ğŸ”¨ æ„å»ºæµ‹è¯•å¹¶å‘å¸ƒ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ è®¾ç½® pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“‚ è·å– pnpm å­˜å‚¨ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
          
      - name: ğŸ—‚ï¸ è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          pnpm install --frozen-lockfile
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸ“‹ ç¡®å®šç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼Œä½¿ç”¨æ ‡ç­¾ä½œä¸ºç‰ˆæœ¬
            VERSION=${GITHUB_REF#refs/tags/}
          else
            # å¦‚æœæ˜¯åˆ†æ”¯æ¨é€ï¼Œä½¿ç”¨package.jsonç‰ˆæœ¬ + commit hash
            PACKAGE_VERSION=$(node -p "require('./package.json').version")
            SHORT_SHA=${GITHUB_SHA::7}
            VERSION="v${PACKAGE_VERSION}-${SHORT_SHA}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${VERSION}"

      - name: ğŸ§ª è¿è¡Œä»£ç æ£€æŸ¥
        run: |
          echo "ğŸ” è¿è¡ŒåŸºç¡€è¯­æ³•æ£€æŸ¥..."
          pnpm run lint
          echo "âœ… åŸºç¡€è¯­æ³•æ£€æŸ¥é€šè¿‡"
          
          echo "ğŸ” è¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥..."
          pnpm run type-check
          echo "âœ… TypeScriptç±»å‹æ£€æŸ¥é€šè¿‡"

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
          pnpm run build
          echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"

      - name: ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…..."
          mkdir -p release-assets
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION="${{ steps.version.outputs.version }}"
          TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
          
          # åˆ›å»ºéƒ¨ç½²åŒ…ç›®å½•
          echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…..."
          mkdir -p qq-webhook-pro-release
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          echo "ğŸ“ å¤åˆ¶æ„å»ºæ–‡ä»¶..."
          cp -r dist/ qq-webhook-pro-release/
          cp package.json qq-webhook-pro-release/
          cp pnpm-lock.yaml qq-webhook-pro-release/
          cp README.md qq-webhook-pro-release/
          cp PROJECT_SUMMARY.md qq-webhook-pro-release/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          echo "ğŸ“ åˆ›å»ºå¯åŠ¨è„šæœ¬..."
          cat > qq-webhook-pro-release/start.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ å¯åŠ¨ QQ Webhook Pro..."

# æ£€æŸ¥Node.jsç‰ˆæœ¬
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Node.js 18+"
    exit 1
fi

NODE_VERSION=$(node -v | sed 's/v//')
MAJOR_VERSION=$(echo $NODE_VERSION | cut -d. -f1)

if [ "$MAJOR_VERSION" -lt 18 ]; then
    echo "âŒ Node.js ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦ 18+ï¼Œå½“å‰ç‰ˆæœ¬: $NODE_VERSION"
    exit 1
fi

# æ£€æŸ¥pnpm
if ! command -v pnpm &> /dev/null; then
    echo "ğŸ“¦ å®‰è£… pnpm..."
    npm install -g pnpm
fi

# å®‰è£…ç”Ÿäº§ä¾èµ–
echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
pnpm install --prod --frozen-lockfile

# å¯åŠ¨æœåŠ¡
echo "ğŸ‰ å¯åŠ¨æœåŠ¡..."
pnpm start
EOF
          
          chmod +x qq-webhook-pro-release/start.sh
          
          # åˆ›å»ºWindowså¯åŠ¨è„šæœ¬
          cat > qq-webhook-pro-release/start.bat << 'EOF'
@echo off
chcp 65001 >nul
echo ğŸš€ å¯åŠ¨ QQ Webhook Pro...

:: æ£€æŸ¥Node.js
node --version >nul 2>&1
if errorlevel 1 (
    echo âŒ Node.js æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Node.js 18+
    pause
    exit /b 1
)

:: æ£€æŸ¥pnpm
pnpm --version >nul 2>&1
if errorlevel 1 (
    echo ğŸ“¦ å®‰è£… pnpm...
    npm install -g pnpm
)

:: å®‰è£…ç”Ÿäº§ä¾èµ–
echo ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–...
pnpm install --prod --frozen-lockfile

:: å¯åŠ¨æœåŠ¡
echo ğŸ‰ å¯åŠ¨æœåŠ¡...
pnpm start
pause
EOF
          
          # åˆ›å»ºéƒ¨ç½²è¯´æ˜æ–‡ä»¶
          cat > qq-webhook-pro-release/DEPLOY.md << 'EOF'
# QQ Webhook Pro éƒ¨ç½²åŒ…

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Linux/macOS
```bash
./start.sh
```

### Windows
```batch
start.bat
```

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- Node.js 18+
- pnpm (è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…)

## ğŸŒ è®¿é—®åœ°å€

å¯åŠ¨æˆåŠŸåè®¿é—®: http://localhost:3002

é»˜è®¤è´¦å·: admin / admin123

## ğŸ“š æ›´å¤šæ–‡æ¡£

è¯·æŸ¥çœ‹ README.md å’Œ PROJECT_SUMMARY.md
EOF
          
          # æ‰“åŒ…éƒ¨ç½²åŒ…
          echo "ğŸ“¦ æ‰“åŒ…éƒ¨ç½²åŒ…..."
          PACKAGE_NAME="qq-webhook-pro-${VERSION}-${COMMIT_HASH}"
          tar -czf release-assets/${PACKAGE_NAME}.tar.gz qq-webhook-pro-release/
          zip -r release-assets/${PACKAGE_NAME}.zip qq-webhook-pro-release/
          
          echo "âœ… éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -la release-assets/
          
          # ä¿å­˜åŒ…åä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      # ä»…åœ¨æ ‡ç­¾æ¨é€æˆ–æ‰‹åŠ¨è§¦å‘æ—¶å‘å¸ƒ
      - name: ğŸš€ åˆ›å»ºGitHub Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          name: "QQ Webhook Pro ${{ steps.version.outputs.version }}"
          tag_name: ${{ steps.version.outputs.version }}
          prerelease: ${{ github.event.inputs.prerelease == 'true' || !startsWith(github.ref, 'refs/tags/') }}
          generate_release_notes: true
          files: |
            release-assets/*
          body: |
            ## ğŸ‰ QQ Webhook Pro ${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            - **éƒ¨ç½²åŒ… (.tar.gz)**: Linux/macOS æ¨èï¼ŒåŒ…å«å¯åŠ¨è„šæœ¬
            - **éƒ¨ç½²åŒ… (.zip)**: Windows æ¨èï¼ŒåŒ…å«æ‰¹å¤„ç†å¯åŠ¨è„šæœ¬
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„éƒ¨ç½²åŒ…
            2. è§£å‹åˆ°ç›®æ ‡ç›®å½•
            3. è¿è¡Œå¯åŠ¨è„šæœ¬ï¼š
               - Linux/macOS: `./start.sh`
               - Windows: `start.bat`
            4. è®¿é—® http://localhost:3002
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - Node.js 18+
            - pnpm (å¯åŠ¨è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…)
            
            ### ğŸ”‘ é»˜è®¤ç™»å½•
            - ç”¨æˆ·å: `admin`
            - å¯†ç : `admin123`
            
            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸš€ Webhookè½¬WebSocketå®æ—¶æ¶ˆæ¯è½¬å‘
            - ğŸ” Ed25519ç­¾åéªŒè¯ + JWTè®¤è¯
            - ğŸ“Š å®æ—¶ç³»ç»Ÿç›‘æ§ (CPU/å†…å­˜ä½¿ç”¨ç‡)
            - ğŸ¨ ç°ä»£åŒ–Webç®¡ç†ç•Œé¢
            - ğŸŒ™ æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
            - ğŸ“ å®Œæ•´çš„æ“ä½œæ—¥å¿—ç³»ç»Ÿ
            
            ---
            
            ğŸ“š **æ–‡æ¡£**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) | [é¡¹ç›®æ€»ç»“](https://github.com/${{ github.repository }}/blob/main/PROJECT_SUMMARY.md)
            
            ğŸ› **é—®é¢˜åé¦ˆ**: [Issues](https://github.com/${{ github.repository }}/issues)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å§‹ç»ˆä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºArtifact
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ steps.version.outputs.version }}
          path: release-assets/
          retention-days: 30

      - name: ğŸ“¢ æ„å»ºå®Œæˆé€šçŸ¥
        run: |
          echo "âœ… QQ Webhook Pro ${{ steps.version.outputs.version }} æ„å»ºå®Œæˆ!"
          echo ""
          if [[ "${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' }}" == "true" ]]; then
            echo "ğŸš€ å·²å‘å¸ƒåˆ° GitHub Releases"
            echo "ğŸ”— Release é¡µé¢: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          else
            echo "ğŸ“¦ æ„å»ºäº§ç‰©å·²ä¸Šä¼ ä¸º Artifactï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½"
          fi
          echo ""
          echo "ğŸ“ åŒ…å«çš„æ–‡ä»¶:"
          ls -la release-assets/

  